<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custos Manuten√ß√£o e √ìleos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>
    <style>
        /* (MANTIVE SEU CSS ORIGINAL IGUALZINHO PARA N√ÉO QUEBRAR O LAYOUT) */
        :root {
            --bg-body-light: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --color-text-light: #333;
            --bg-container-light: white;
            --bg-controls-light: #f8f9fa;
            --color-label-light: #495057;
            --bg-input-light: white;
            --border-input-light: #ced4da;
            --bg-chart-light: white;
            --info-icon-color-light: #aaa;
            --info-icon-hover-color-light: #667eea;
            --msg-error-bg-light: #f8d7da;
            --msg-error-border-light: #f5c6cb;
            --msg-error-color-light: #721c24;
            --msg-success-bg-light: #d4edda;
            --msg-success-border-light: #c3e6cb;
            --msg-success-color-light: #155724;
            --modal-bg-light: #fefefe;
            --modal-border-light: #888;
            --modal-header-border-light: #dee2e6;
            --modal-table-border-light: #ddd;
            --modal-table-header-bg-light: #f2f2f2;
            --rules-li-bg-light: #f8f9fa;
            --rules-li-border-light: #667eea;
            --modal-table-stripe-bg-light: #f9f9f9;
            --bg-body-dark: #1a1a2e;
            --color-text-dark: #e0e0e0;
            --bg-container-dark: #2c2c3e;
            --bg-controls-dark: #242434;
            --color-label-dark: #c0c0d0;
            --bg-input-dark: #1f1f30;
            --border-input-dark: #4a4a6a;
            --bg-chart-dark: #242434;
            --info-icon-color-dark: #888;
            --info-icon-hover-color-dark: #a6b1ee;
            --msg-error-bg-dark: #5a1e22;
            --msg-error-border-dark: #f5c6cb;
            --msg-error-color-dark: #f8d7da;
            --msg-success-bg-dark: #1e4b28;
            --msg-success-border-dark: #c3e6cb;
            --msg-success-color-dark: #d4edda;
            --modal-bg-dark: #2c2c3e;
            --modal-border-dark: #4a4a6a;
            --modal-header-border-dark: #4a4a6a;
            --modal-table-border-dark: #4a4a6a;
            --modal-table-header-bg-dark: #1f1f30;
            --rules-li-bg-dark: #242434;
            --rules-li-border-dark: #667eea;
            --modal-table-stripe-bg-dark: #242434;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: var(--bg-body-light); color: var(--color-text-light); min-height: 100vh; box-sizing: border-box; transition: background 0.3s, color 0.3s; }
        body.dark-mode { background: var(--bg-body-dark); color: var(--color-text-dark); }
        .container { background: var(--bg-container-light); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        body.dark-mode .container { background: var(--bg-container-dark); }
        .title-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-right: 60px; }
        .title-container h1 { margin: 0; font-size: 2em; }
        .theme-switcher { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; transition: all 0.3s; }
        body.dark-mode .theme-switcher { border-color: #4a4a6a; color: #e0e0e0; }
        .file-input { display: none; }
        .upload-btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 10px 18px; border: none; border-radius: 25px; font-size: 15px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); white-space: nowrap; }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .controls-container { background-color: var(--bg-controls-light); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        body.dark-mode .controls-container { background-color: var(--bg-controls-dark); }
        .metas-container, .period-selector-container { display: flex; gap: 20px; }
        .period-selector-container { margin-top: 20px; }
        .meta-input-group, .period-selector-group { display: flex; flex-direction: column; flex: 1; }
        .meta-input-group label, .period-selector-group label { margin-bottom: 5px; font-weight: bold; color: var(--color-label-light); }
        body.dark-mode .meta-input-group label, body.dark-mode .period-selector-group label { color: var(--color-label-dark); }
        .meta-input-group input, .period-selector-group select { padding: 10px; border-radius: 5px; border: 1px solid var(--border-input-light); font-size: 16px; background-color: var(--bg-input-light); color: var(--color-text-light); }
        body.dark-mode .meta-input-group input, body.dark-mode .period-selector-group select { background-color: var(--bg-input-dark); border-color: var(--border-input-dark); color: var(--color-text-dark); }
        .chart-container { margin-top: 30px; background: var(--bg-chart-light); border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; height: 450px; }
        body.dark-mode .chart-container { background: var(--bg-chart-dark); }
        .info-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; color: var(--info-icon-color-light); cursor: pointer; z-index: 10; transition: color 0.3s ease; }
        body.dark-mode .info-icon { color: var(--info-icon-color-dark); }
        .info-icon:hover { color: var(--info-icon-hover-color-light); }
        body.dark-mode .info-icon:hover { color: var(--info-icon-hover-color-dark); }
        .decimal-toggle { position: absolute; top: 24px; right: 55px; font-size: 14px; cursor: pointer; z-index: 10; background: rgba(0, 0, 0, 0.1); color: #888; padding: 2px 6px; border-radius: 4px; font-weight: bold; transition: all 0.3s ease; user-select: none; }
        body.dark-mode .decimal-toggle { background: rgba(255, 255, 255, 0.1); color: #aaa; }
        .decimal-toggle.active { background: #667eea; color: white; }
        .decimal-toggle:hover { transform: scale(1.1); }
        .pareto-chart-container { height: 600px; }
        .slider-container { padding: 10px 0; text-align: center; }
        .slider-container label { margin-right: 10px; font-weight: bold; color: var(--color-label-light); }
        body.dark-mode .slider-container label { color: var(--color-label-dark); }
        .slider-container input[type="range"] { width: 50%; }
        .message-box { border: 1px solid; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        .error { background: var(--msg-error-bg-light); border-color: var(--msg-error-border-light); color: var(--msg-error-color-light); }
        body.dark-mode .error { background: var(--msg-error-bg-dark); border-color: var(--msg-error-border-dark); color: var(--msg-error-color-dark); }
        .success { background: var(--msg-success-bg-light); border-color: var(--msg-success-border-light); color: var(--msg-success-color-light); }
        body.dark-mode .success { background: var(--msg-success-bg-dark); border-color: var(--msg-success-border-dark); color: var(--msg-success-color-dark); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--modal-bg-light); margin: 2% auto; padding: 20px; border: 1px solid var(--modal-border-light); width: 95%; max-width: 95%; height: 90vh; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        body.dark-mode .modal-content { background-color: var(--modal-bg-dark); border-color: var(--modal-border-dark); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--modal-header-border-light); padding-bottom: 15px; margin-bottom: 15px; }
        body.dark-mode .modal-header { border-bottom-color: var(--modal-header-border-dark); }
        .modal-header-buttons { display: flex; align-items: center; gap: 15px; }
        .export-btn { background: #1d6f42; color: white; padding: 8px 16px; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; transition: background 0.3s ease; }
        .export-btn:hover { background: #27965a; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; }
        body.dark-mode .close-button:hover, body.dark-mode .close-button:focus { color: white; }
        #modalTableContainer, #rulesModalBody { max-height: none; flex: 1; overflow-y: auto; }
        #modalTable { width: 100%; border-collapse: collapse; font-size: 14px; }
        #modalTable th, #modalTable td { border: 1px solid var(--modal-table-border-light); padding: 12px; text-align: left; vertical-align: middle; white-space: nowrap; }
        body.dark-mode #modalTable th, body.dark-mode #modalTable td { border-color: var(--modal-table-border-dark); }
        #modalTable th { background-color: var(--modal-table-header-bg-light); position: sticky; top: 0; font-weight: bold; cursor: pointer; user-select: none; }
        #modalTable th.sort-asc::after { content: ' ‚ñ≤'; font-size: 0.8em; }
        #modalTable th.sort-desc::after { content: ' ‚ñº'; font-size: 0.8em; }
        body.dark-mode #modalTable th { background-color: var(--modal-table-header-bg-dark); }
        #modalTable tbody tr:nth-child(even) { background-color: var(--modal-table-stripe-bg-light); }
        body.dark-mode #modalTable tbody tr:nth-child(even) { background-color: var(--modal-table-stripe-bg-dark); }
        #rulesModalBody ul { list-style-type: none; padding-left: 0; }
        #rulesModalBody li { background: var(--rules-li-bg-light); border-left: 3px solid var(--rules-li-border-light); padding: 10px; margin-bottom: 10px; border-radius: 3px; }
        body.dark-mode #rulesModalBody li { background: var(--rules-li-bg-dark); border-left-color: var(--rules-li-border-dark); }
        #rulesModalBody strong { color: #333; }
        body.dark-mode #rulesModalBody strong { color: #e0e0e0; }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <button id="themeSwitcher" class="theme-switcher">‚òÄÔ∏è</button>
        <div class="title-container">
            <h1>üìä Custos Manuten√ß√£o e √ìleos</h1>
            <label for="fileInput" class="upload-btn">Carregar Manual (.xlsx)</label>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
        </div>

        <div class="controls-container">
            <div class="metas-container">
                <div class="meta-input-group">
                    <label for="metaManutencaoInput">Meta Manuten√ß√£o (R$)</label>
                    <input type="number" id="metaManutencaoInput" value="720000" step="1000">
                </div>
                <div class="meta-input-group">
                    <label for="metaOleosInput">Meta √ìleos e Lubrificantes (R$)</label>
                    <input type="number" id="metaOleosInput" value="406000" step="1000">
                </div>
            </div>
            <div class="period-selector-container">
                 <div class="period-selector-group">
                    <label for="yearSelector">Ano</label>
                    <select id="yearSelector"></select>
                </div>
                <div class="period-selector-group">
                    <label for="monthSelector">M√™s</label>
                    <select id="monthSelector"></select>
                </div>
            </div>
        </div>
        
        <div class="message-box error" id="errorMsg"></div>
        <div class="message-box success" id="successMsg"></div>
        
        <div class="chart-container">
            <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
            <span class="info-icon" data-chart-id="manutencaoChart">&#9432;</span>
            <canvas id="manutencaoChart"></canvas>
        </div>
        <div class="chart-container">
            <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
            <span class="info-icon" data-chart-id="oleosChart">&#9432;</span>
            <canvas id="oleosChart"></canvas>
        </div>
        <div class="chart-container">
            <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
            <span class="info-icon" data-chart-id="evolucaoMensalManutencaoChart">&#9432;</span>
            <canvas id="evolucaoMensalManutencaoChart"></canvas>
        </div>
         <div class="chart-container">
            <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
            <span class="info-icon" data-chart-id="evolucaoMensalOleosChart">&#9432;</span>
            <canvas id="evolucaoMensalOleosChart"></canvas>
        </div>
        
        <div class="chart-container pareto-chart-container">
             <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
             <span class="info-icon" data-chart-id="paretoManutencaoChart">&#9432;</span>
             <div class="slider-container">
                <label for="paretoManutencaoSlider">Itens a Exibir:</label>
                <input type="range" id="paretoManutencaoSlider" min="1" max="20" value="10">
                <span id="paretoManutencaoSliderValue">10</span>
            </div>
            <canvas id="paretoManutencaoChart"></canvas>
        </div>
        <div class="chart-container pareto-chart-container">
             <span class="decimal-toggle active" title="Alternar casas decimais">.00</span>
             <span class="info-icon" data-chart-id="paretoEntradaProdutoManutencaoChart">&#9432;</span>
             <div class="slider-container">
                <label for="paretoEntradaProdutoManutencaoSlider">Itens a Exibir:</label>
                <input type="range" id="paretoEntradaProdutoManutencaoSlider" min="1" max="20" value="10">
                <span id="paretoEntradaProdutoManutencaoSliderValue">10</span>
            </div>
            <canvas id="paretoEntradaProdutoManutencaoChart"></canvas>
        </div>
        </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes</h2>
                <div class="modal-header-buttons">
                    <button id="exportExcelBtn" class="export-btn">üì• Exportar Excel</button>
                    <span class="close-button" id="closeDetailsModal">&times;</span>
                </div>
            </div>
            <div id="modalTableContainer">
                <table id="modalTable"></table>
            </div>
        </div>
    </div>

    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rulesModalTitle">Regras de An√°lise</h2>
                <span class="close-button" id="closeRulesModal">&times;</span>
            </div>
            <div id="rulesModalBody"></div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let manutencaoChart, oleosChart, evolucaoMensalManutencaoChart, evolucaoMensalOleosChart, paretoManutencaoChart, paretoOleosChart, paretoEntradaProdutoManutencaoChart, paretoEntradaProdutoOleosChart, paretoEntradaFornecedorManutencaoChart, paretoEntradaFornecedorOleosChart, paretoConsumoCCManutencaoChart, paretoConsumoCCOleosChart = null;
        let detailedData = {}; 
        let globalConsumoData = [], globalEntradaData = [], globalParetoManutencaoData = {}, globalParetoOleosData = {}, globalParetoEntradaProdutoManutencaoData = {}, globalParetoEntradaProdutoOleosData = {}, globalParetoEntradaFornecedorManutencaoData = {}, globalParetoEntradaFornecedorOleosData = {}, globalParetoConsumoCCManutencaoData = {}, globalParetoConsumoCCOleosData = {};
        
        let showDecimals = true;

        const fileInput = document.getElementById('fileInput');
        const errorDiv = document.getElementById('errorMsg');
        const successDiv = document.getElementById('successMsg');
        const detailsModal = document.getElementById('detailsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalTable = document.getElementById('modalTable');
        const closeDetailsModal = document.getElementById('closeDetailsModal');
        const rulesModal = document.getElementById('rulesModal');
        const rulesModalTitle = document.getElementById('rulesModalTitle');
        const rulesModalBody = document.getElementById('rulesModalBody');
        const closeRulesModal = document.getElementById('closeRulesModal');
        const metaManutencaoInput = document.getElementById('metaManutencaoInput');
        const metaOleosInput = document.getElementById('metaOleosInput');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const yearSelector = document.getElementById('yearSelector');
        const monthSelector = document.getElementById('monthSelector');
        
        // Sliders (Verifique se todos os IDs existem no seu HTML completo)
        const sliders = {
            paretoManutencao: { slider: document.getElementById('paretoManutencaoSlider'), value: document.getElementById('paretoManutencaoSliderValue') },
            // ... Mantenha o mapeamento dos sliders se existirem no HTML
        };
        const themeSwitcher = document.getElementById('themeSwitcher');

        // --- MANTER TODAS AS FUN√á√ïES DE TEMA, SLIDER E GR√ÅFICOS DO C√ìDIGO ORIGINAL AQUI ---
        // (Copie as fun√ß√µes setChartTheme, redrawCharts, createOrUpdateBarChart, etc. do seu c√≥digo anterior)
        // ...
        
        // --- FUN√á√ÉO DE AUTO-LOAD (NOVIDADE) ---
        async function carregarDadosAutomaticos() {
            try {
                showMessage(successDiv, 'Buscando dados atualizados do Bot...');
                
                // Tenta buscar o arquivo gerado pelo Bot
                const response = await fetch('dados_dashboard.xlsx');
                
                if (!response.ok) {
                    throw new Error("Arquivo 'dados_dashboard.xlsx' n√£o encontrado.");
                }

                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                // Processa Automaticamente
                processWorkbook(workbook);
                showMessage(successDiv, 'Dados carregados automaticamente com sucesso!');
                
            } catch (error) {
                console.warn("Auto-load falhou:", error);
                showMessage(errorDiv, 'Dados autom√°ticos n√£o encontrados. Use o bot√£o para carregar manualmente.');
            }
        }

        function processWorkbook(workbook) {
            // O Bot garante que a primeira aba √© Consumo e a segunda √© Entrada
            // E o Bot j√° limpou as linhas, ent√£o lemos direto
            const sheetNames = workbook.SheetNames;
            
            if (sheetNames.length < 2) {
                showMessage(errorDiv, 'O arquivo Excel precisa ter pelo menos 2 abas (Consumo e Entrada).');
                return;
            }

            // L√™ as abas pelo √≠ndice, confiando na ordem que o Bot salvou
            const sheetConsumo = workbook.Sheets[sheetNames[0]]; 
            const sheetEntrada = workbook.Sheets[sheetNames[1]];

            const jsonOptions = { header: 1, defval: null };
            
            // Como o Bot j√° limpou o cabe√ßalho, lemos normal
            globalConsumoData = XLSX.utils.sheet_to_json(sheetConsumo, jsonOptions);
            globalEntradaData = XLSX.utils.sheet_to_json(sheetEntrada, jsonOptions);
            
            redrawCharts(); 
        }

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            // Suas fun√ß√µes de init originais
            // populateDateSelectors(); // (Se voc√™ tiver essa fun√ß√£o definida)
            // setChartTheme(document.body.classList.contains('dark-mode'));
            
            // Tenta carregar os dados
            carregarDadosAutomaticos();
        });

        // Event Listeners (Manter os originais)
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        // ... (demais listeners)

        // --- MANTENHA O RESTANTE DAS FUN√á√ïES DO SEU C√ìDIGO ORIGINAL ABAIXO ---
        // (handleFile, calculateTotal, functions de gr√°ficos, etc.)
    </script>
</body>
</html>